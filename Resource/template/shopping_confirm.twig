{% if Order.Payment.getMethodClass == 'Plugin\\UnivaPayPlugin\\Service\\Method\\CreditCard' %}
{% set config = repository('Plugin\\UnivaPayPlugin\\Entity\\Config').findById(1)[0] %}
{{ form_widget(form.univapay_charge_id) }}
<script src="{{ config.getApiUrl() }}/client/checkout.js"></script>
<script>
    form = document.querySelector("#shopping-form");
    chargeId = document.querySelector("#shopping_order_univapay_charge_id");
    form.appendChild(chargeId);
    checkout = UnivapayCheckout.create({
        appId: "{{ config.getAppId() }}",
        checkout: "payment",
        amount: {{ Order.payment_total }},
        currency: "{{ Order.currency_code }}",
        email: "{{ Order.email }}",
        metadata: { orderNo: "{{ Order.order_no }}" },
        onSuccess: (result) => {
            chargeId.value = result.response.id;
            form.submit();
        },
        onError: () => {
            alert("エラーが発生しました。サイト管理者にお問い合わせください。");
            window.history.back(-1);
        },
        closed: () => {
            alert("決済が中断されました");
            window.history.back(-1);
        }
    });
    form.addEventListener("submit", () => {
        event.preventDefault();
        checkout.open();
    });
</script>
{% endif %}
